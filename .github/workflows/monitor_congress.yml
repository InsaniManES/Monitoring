name: Monitor Website

on:
  schedule:
    - cron: "*/5 * * * *"  # every 5 minutes
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch page
        run: |
          curl -s https://www.latino.co.il/r/ > page.html

      - name: Check if keyword exists
        id: check
        run: |
          # Same logic as monitor.py: case-insensitive, collapse whitespace
          tr -s ' \n\t\r' ' ' < page.html | tr '[:upper:]' '[:lower:]' > page_normalized.txt
          if grep -qF "registration will open on" page_normalized.txt; then
            echo "status=closed" >> $GITHUB_OUTPUT
          else
            echo "status=open" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram message if changed
        if: steps.check.outputs.status == 'open'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d text="ðŸš¨ Registration is OPEN: https://www.latino.co.il/r/"

      - name: Debug
        run: |
          echo "URL is $URL"
          cat page.html | head -20